---
title: "scRNA_Smart-Seq2"
author: "Saleem Mansour"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This Analysis involves annotated plate-based mice tissues from [Figshare](https://doi.org/10.6084/m9.figshare.5715040.v1).

The site offers:

1.  Annotation file

2.  The data archive file (containing csv files of each tissue)

3.  Metadata

So I Choose **Brain_Neurons** tissue. My objectives include:

I.  Apply the standard pre-processing pipeline Using Seurat Object.

II. Compare DimPlots of generated clusters against gender of mice

III. Visualize the distribution percentages of each subtissue among genders

IV. Find most deferentially expressed genes among two subtissues of my choice

V.  Visualize the compared subtissues using a heatmap.

### I. Apply standard pre-processing

load needed libraries

```{r Libraries, message=FALSE, warning=FALSE, results='hide'}
library(Seurat)
library(ggplot2)
library(plotly)
library(tidyverse)
library(patchwork)
```

And assign needed data:

```{r data read,message=FALSE,warning=FALSE, results='hide'}
data <- read.csv("Seurat/Brain_Neurons-counts.csv", row.names = 1)
meta <- read.csv("Seurat/metadata_FACS.csv")
anno <- read.csv("Seurat/annotations_FACS.csv")
```

I need some wrangling at start (filtering annotation and meta files for my chosen tissue, adding mitochondrial genes percentage column, adding IDs as separate column), and create the Seurat object:

```{r first wrangling and seur.obj ,message=FALSE,warning=FALSE, results='hide'}
anno_filtered <- filter(anno, tissue == "Brain_Neurons")
meta_filtered <- filter(meta, tissue == "Brain_Neurons")

seur <- CreateSeuratObject(data)
seur[["percent_mito"]] = PercentageFeatureSet(seur, pattern = "^MT-")
seur@meta.data$IDs <- rownames(seur@meta.data)
```

A first glance at data:

```{r vln, fig.align='center',message=FALSE, warning=FALSE, fig.dim=c(6,5)}
VlnPlot(seur, features = c("nFeature_RNA", "nCount_RNA", "percent_mito"), ncol = 3, )
```

```{r scatter, fig.align='center',message=FALSE, warning=FALSE, fig.dim=c(10,6)}
FeatureScatter(seur, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
```

For QC, Seems that cells with mitochondrial genes are already filtered, so I won't include them.

We can conclude from the previous plots (high features and low counts) that probably the sequencing depth (coverage) is not high.

here I construct my main Seurat obj (seur_mod) that results from pre-processing, Dim linear reduction:

```{r seur_mod, message=FALSE, warning=FALSE, results='hide'}
genes <- rownames(seur)

seur_mod <- seur %>%
  subset(subset = nFeature_RNA > 200 & nFeature_RNA < 5000) %>% 
  NormalizeData() %>% 
  FindVariableFeatures(selection.method = "vst", nfeatures = 2000) %>% 
  ScaleData(features = genes) %>%
  RunPCA()
```

We can check best dimensionality after which variation insignificant; using Elbow plot (It seems that dims 1:30 hold the majority of variation, as so adjust later steps):

```{r Elbow,message=FALSE, warning=FALSE}
ElbowPlot(seur_mod, ndims = 50)
```


```{r seur_mod 2,message=FALSE, warning=FALSE, results='hide'}
seur_mod <- seur_mod %>% 
  RunUMAP(dims = 1:30) %>%
  FindNeighbors(dims = 1:30) %>% 
  FindClusters(resolution = 0.3)
```
